# 第7章 核心探秘2【面试宝典】

## 1.请你描述出货的流程，绘制流程图。

（1）我们下单支付成功后，微信支付平台会回调一个接口，我们在会回调接口中解析出订单号。

（2）修改订单状态为已支付和支付状态为支付完成，然后在通过emq异步调用售货机微服务。

（3）在售货机微服务中，我们得到有库存的货道，扣减此货道的库存，保存一个出货的流水表，最后我们通过emq发送消息到售货机终端。

（4）售货机终端收到消息后，也会保存一张出货流水表保存出货的结果，出货成功与失败，售货机终端都会返回一个结果服务端。

（5）服务端的售货机微服务和订单微服务会采用带群组的共享订阅来接收出货结果， 订单微服务根据结果来进行出货成功的状态更改，如果失败会启动退款流程，售货机微服务接到出货失败的结果会回滚库存 。



## 2.如何理解分布式事务的最终一致性？

在分布式结构中，微服务有各自独立的数据库，并不能在一个事务中，所以会有可能造成数据不一致的问题。

分布式事务的最终一致性，不要求在同一时间保证一致，而是保证最终一致。通常是使用MQ来实现。 

例如我们在项目中，售货机微服务和售货机终端两个节点，如果因为网络问题导致数据不一致，会采用补偿机制来解决。售货机微服务和售货机终端两方都需要有个出货记录表，在售货机微服务下发出货指令时，出货状态为false, 在收到售货机终端返回的结果时，会修改为true . 售货机终端在收到出货指令时会增加出货记录，成功出货后会向售货机微服务发送出货结果，如果成功传递则修改出货记录为成功状态。一旦发生网络故障，造成数据不一致时，可以采用定时补偿的方式，待网络恢复，即可同步两端的状态，保持最终一致。



## 3.项目中是否使用过分布式锁，场景是什么？如何使用的？

在售货机项目中使用consul的分布式锁。

使用场景：在同一台售货机，不能出现两个人同时购买的场景，必须要第一个人购物流程结束后，才能开始下一个购物流程，这时候就会使用到分布式锁。

如何使用：在调用微信支付创建订单的时候我们会加上锁，在售货机扣减库存后，我们就会立即释放锁。我们会为锁加上过期时间为1分钟。如果用户在下单1分钟内没有支付，则自动释放锁。



## 4.对比一下，你使用过的分布式锁。

（1）基于数据库实现分布式锁： 建立一张表，利用唯一索引来实现。插入成功的就是可以成功获取锁。

优点：使用简单，不需要引入其它中间件。

缺点：没有过期功能。

（2）基于缓存（Redis等）实现分布式锁： 基于SETNX命令实现的。

优点：有很高的性能，使用起来比较方便。

缺点：存在脑裂问题，会导致数据不一致，锁安全失效。所以Redis是遵循了CAP中的AP，具有可用性，但不具有一致性。

（3）基于Consul实现分布式锁；Consul依赖K/V与session的绑定关系，进而完成互斥锁定 。

优点：遵循了CAP中的CP ，具有一致性。

缺点：会有一定的延迟。

## 5.如果售货机出货发生故障，后续该如何处理？

服务端的售货机微服务和订单微服务会采用带群组的共享订阅来接收出货结果。

订单微服务根据结果来进行出货成功的状态更改，如果失败会启动退款流程，修改订单状态为出货失败。

售货机微服务接到出货失败的结果会回滚库存 ，将出货记录的状态标记为失败。



