# 第5章 工单业务【面试宝典】

## 1.为什么会有自动工单？（意义是什么）

 为了降低运营成本，自动维修工单是当设备出现故障，自动创建维修工单；自动补货工单是每天凌晨扫描售货机货道，根据货道的商品库存，自动创建补货工单。自动工单，可以极大降低人力成本。

## 2.如何实现自动工单？

自动维修工单，工单微服务会通过EMQ接收来自售货机终端发来的部件状态报文，如果有其中一个部件的状态为FALSE，则自动创建维修工单。

自动补货工单，通过XXL-JOB  运行售货机微服务的定时任务。任务扫描所有运营状态的售货机，把货道库存补全，由售货机微服务发送消息到工单微服务，工单微服务接到消息后创建工单。



## 3.自动工单指派人规则是什么？如何实现？

自动工单指派人规则是获取当前最少的工单量的员工，这样是为了使每个人的工单量保持均衡。

为了实现查询的高效性，使用redis缓存的ZSET来实现每个员工工单数的存储，因为ZSET是可以自动排序的。我们将key 设置为日期+区域+工单类型。值为员工id，分数为工单数。

通过XXL-job定时任务，每日初始化第2天的数据，也就是让每个人的工单数为0。

当员工分配工单后都会增加redis的工单数，如果取消则减少。我们要获取自动工单指派人，只需要从ZSET提取第1条即可。

## 4.自动维修工单是如何实现的？

自动维修工单，工单微服务会通过EMQ接收来自售货机终端发来的部件状态报文，如果有其中一个部件的状态为FALSE，则自动创建维修工单。



## 5.自动补货工单是如何实现的？

自动补货工单，通过XXL-JOB  运行售货机微服务的定时任务。任务扫描所有运营状态的售货机，把货道库存补全，由售货机微服务发送消息到工单微服务，工单微服务接到消息后创建工单。

## 6.项目中有没有使用分布式任务调度，什么技术，在什么场景下使用？

项目使用了XXL-job，用于工单列表初始化，自动补货工单等场景。

## 7.XXL-job 阻塞策略

单机串行：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；

丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；

覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；

## 8. 如果一个定时任务执行时间很长，我们如何缩短执行时间？

我们可以使用xxl-job 的分片广播来执行任务。我们可以在任务中获取分片总数和当前分片索引，然后在查询数据时添加个条件，用id对分片总数取余等于当前分片索引。这样我们就可以将数据进行切分。id值越连续，分片数据则越均匀。 

## 9. EMQ带群组共享订阅在项目中的场景

所有的消息都是采用共享订阅，因为我们要微服务集群只有一个节点可以获取到消息。

在售货机项目中，售货机要进行设备自检，并将自检报文定时发送到服务端来进行处理，服务端有两个微服务都需要处理这个消息，一个是售货机微服务，一个是工单微服务。售货机微服务需要根据此报文修改售货机运行状态（正常、异常）。工单微服务需要根据此报文，创建自动维修工单。这样我们就需要使用带群组共享订阅。工单微服务和售货机微服务各为一个群组。而每个群组只有一个节点会收到并处理消息。

